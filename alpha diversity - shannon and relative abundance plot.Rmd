---
title: "Diversity Analysis"
author: "Tom Brouwers"
date: "2025-07-08"
output: pdf_document
---
This file is for looking into alpha diversity and relative abunance of M, W1 and W2 samples.  
```{r setup, include=FALSE}
library(tidyverse)
library(vegan)
library(patchwork)
library(Polychrome)
library(fmsb)
library(colorspace)
library(RColorBrewer)
getwd()
setwd("E:/Msc/Thesis/R")
```
# Now we want to get the data
```{r, echo=FALSE}
df <- read_tsv("E:/Msc/Thesis/Data/Sequencing/250627_taxon_out.tsv")

# both bacteria and plant df have been defined in other R files. 

df_bacteria <- df_bacteria %>%
  group_by(library)

df_plants <- df_plants %>%
  group_by(library) %>%
  mutate(total_sum_genus_count = sum(genus_count_assembly, na.rm = TRUE))

site_assign_list2 <- site_assign_list %>%
  mutate(library = str_remove(library, "Lib.J."))

site_order <- c(
  "M",
  "W1",
  "W2"
)

```

# relative abundance plots
```{r, echo=FALSE}
df_rel_libs <- df_plants %>%
  group_by(library) %>%
  mutate(rel_abundance = sum_genus_count / sum(sum_genus_count, na.rm = TRUE)) %>%
  mutate(total_sum_genus_count = sum(genus_count_assembly, na.rm = TRUE)) %>%
  ungroup()

# find top 10 genera and group rest as 'other' 
df_rel_top <- df_rel_libs %>%
  group_by(library, genus_name) %>%
  summarise(rel_abundance = sum(rel_abundance, na.rm = TRUE),
            .groups = "drop_last") %>%
  mutate(rank = rank(-rel_abundance, ties.method = "first")) %>%
  mutate(genus_name = if_else(rank <= 10, genus_name, "Other")) %>%
  group_by(library, genus_name) %>%
  summarise(rel_abundance = sum(rel_abundance), .groups = "drop") 

view(unique(df_rel_top$genus_name))
# keep genera that contribute >3%, collaps rest as 'other' 
df_rel_performers <- df_rel_libs %>%
  group_by(library) %>%
  mutate(genus_name = if_else(rel_abundance > 0.03, genus_name, "Other")) %>%
  group_by(library, genus_name) %>%
  summarise(rel_abundance = sum(rel_abundance, na.rm = TRUE), .groups = "drop") %>%
  arrange(library, desc(rel_abundance))

view(unique(df_rel_performers$genus_name))
# order so "other" is at top
genus_order <- df_rel_performers %>%
  group_by(library, genus_name) %>%
  summarise(total = sum(rel_abundance), .groups = "drop") %>%
  arrange(desc(genus_name == "Other"), total) %>%
  pull(genus_name)

genus_order <- unique(genus_order)

df_rel_performers <- df_rel_performers %>%
  mutate(genus_name = factor(genus_name, levels = genus_order))
```


# Diversity, evenness, richness per sample
```{r}
# abs = absolute values, veg = vegetation, genus indicatos we are working in genus level
df_abs_veg_genus <- df_plants %>%
  select(library, genus_name, sum_genus_count) %>%
  pivot_wider(
    names_from = genus_name,
    values_from = sum_genus_count,
    values_fill = 0
  ) %>%
  column_to_rownames("library") %>%
  mutate(across(everything(), as.numeric))

# Shannon-Index
shannon_veg <- diversity(df_abs_veg_genus, index = 'shannon') 
# as tibble
df_alpha_div <- tibble::tibble(
  library = names(shannon_veg),
  shannon = as.numeric(shannon_veg)
)
# To get an idea why some have higher or lower SI (shannon index) we make a df with SI, richness (S) and evenness (J)
df_plants_sum <- df_plants %>%
  select(library, genus_name) %>%
  group_by(library) %>%
  summarise(
    richness = n_distinct(genus_name),
    .groups = "drop"
    )
df_alpha_div <- df_alpha_div %>%
  left_join(df_plants_sum, by = "library") 

df_alpha_div <- df_alpha_div %>%
  mutate(evenness = shannon / log(richness)) %>%
  select(library, shannon, richness, evenness) %>%
  filter(!library == "Lib.J.1044") %>%
  mutate(library = str_remove(library, "Lib.J.")) %>%
  left_join(site_assign_list2, site, by = "library") %>%
  mutate(site = factor(site, levels = site_order))

# adjust df for plotting
df_alpha_plot <- df_alpha_div %>%
  pivot_longer(
    cols = c(shannon, richness, evenness),
    names_to = "metric",
    values_to = "value"
  )

# per site if we want to get an overview this way
df_alpha_div_loc <-  df_alpha_div %>%
  filter(!library == "1042") %>%
  group_by(site) %>%
  summarise(
    mean_shannon = mean(shannon, na.rm = TRUE),
    sd_shannon = sd(shannon, na.rm = TRUE),
    mean_evenness = mean(evenness, na.rm = TRUE),
    sd_evenness = sd(evenness, na.rm = TRUE),
    mean_richness = mean(richness, na.rm = TRUE),
    sd_richness = sd(richness, na.rm = TRUE),
    n_samples = n()
  )

location_colours <- c(
  "Moehne" = "tomato",     # reddish
  "Wester 1" = "green3",   # greenish
  "Wester 2" = "blue"    # blueish
)

```

# now we make diversity, richness, evenness plots
```{r, echo=FALSE}
df_alpha_div <- df_alpha_div %>%
  mutate(site = fct_relevel(site, "W2", "W1", "M"))

plot_shannon <- ggplot(df_alpha_div, aes(x = library, y = shannon)) +
  geom_bar(stat = "identity", fill = "darkviolet") +
  facet_grid(.~ site, scales = "free_x", space = "free_x") +
  labs(title = "Shannon-Index",
       y = "H'",
       x = " ") +
  theme(
    plot.title   = element_text(size = 26, face = "bold", hjust = 0.5),
    axis.text    = element_text(size = 22, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title   = element_text(size = 22, face = "bold"),
    axis.title.x = element_blank(),
    strip.text = element_text(size = 24, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 20)
  )

plot_shannon

plot_richness <- ggplot(df_alpha_div, aes(x = library, y = richness)) +
  geom_bar(stat = "identity", fill = "royalblue3") +
  facet_grid(.~ site, scales = "free_x", space = "free_x") +
  labs(y = "S",
       title = "Richness") +
  theme(
    plot.title   = element_text(size = 26, face = "bold", hjust = 0.5),
    axis.text    = element_text(size = 22, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title   = element_text(size = 22, face = "bold"),
    axis.title.x = element_blank(),
    strip.text = element_text(size = 24, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 20)
  )

plot_evenness <- ggplot(df_alpha_div, aes(x = library, y = evenness)) +
  geom_bar(stat = "identity", fill = "tomato2") +
  facet_grid(.~ site, scales = "free_x", space = "free_x") +
  labs(y = "J",
       title = "Evenness",
       x = "Library") +
  theme(
plot.title   = element_text(size = 26, face = "bold", hjust = 0.5),
    axis.text    = element_text(size = 22, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title   = element_text(size = 22, face = "bold"),
    axis.title.x = element_blank(),
    strip.text = element_text(size = 24, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 20)
  )
plot_shannon
plot_evenness
plot_richness
# now for vertical stacking
plot_alpha_div <- plot_shannon / plot_spacer() / plot_richness / plot_spacer() / plot_evenness + plot_layout(ncol = 1)
# vertical stacking is a bit wonky so we'll merge them in post
plot_alpha_div
ggsave("E:/Msc/Thesis/Data/Plots/Diversity/alpha diversity/alpha_div_shannon1.jpg", plot_shannon, width = 30, height = 15, units = "cm", dpi = 300)
ggsave("E:/Msc/Thesis/Data/Plots/Diversity/alpha diversity/alpha_div_richness1.jpg", plot_richness, width = 30, height = 15, units = "cm", dpi = 300)
ggsave("E:/Msc/Thesis/Data/Plots/Diversity/alpha diversity/alpha_div_evenness1.jpg", plot_evenness, width = 30, height = 15, units = "cm", dpi = 300)
```
# Bar plot is ugly, try spider plot per site
```{r, echo=FALSE}
# Normalize axis so they are all equal
df_scaled_spider <- df_alpha_div_loc %>%
  mutate(across(c(mean_shannon, mean_richness, mean_evenness), ~ (. - min(.)) / (max(.) - min(.))))

# format data for fmsb
spider_data <- df_scaled_spider %>%
  select(mean_shannon, mean_richness, mean_evenness) %>%
  as.data.frame()
spider_data <- rbind(
  rep(1, 3), # max
  rep(0,3),  # min
  spider_data
)
rownames(spider_data) <- c("Max", "Min", df_alpha_div_loc$library)

```

# This section is no longer needed since we made heatmaps for relative abundance
## Custom colours
```{r, echo=FALSE}
colours_top_libs <- c(
  "Salix"       = "#1b9e77",
  "Humulus"     = "green",
  "Alnus"       = "slateblue",
  "Quercus"     = "magenta4",
  "Fagus"       = "mediumblue",
  "Ramunculus"  = "tomato",
  "Corylus"     = "khaki3",
  "Filipendula" = "hotpink",
  "Persicaria"  = "lightsalmon4",
  "Acer"        = "orange",
  "Fraxinus"    = "yellow",
  "Polygonum"  =  "brown",
  "Other"       = "grey40"
)
# manually set colours
colours_rel_abundance <- c(
  "Salix"      = "#1b9e77",  # strong green
  "Humulus"    = "#d95f02",  # vivid orange
  "Alnus"      = "#7570b3",  # medium blue-violet
  "Quercus"    = "#e7298a",  # magenta-pink
  "Persicaria" = "#66a61e",  # olive green
  "Polygonum"  = "#e6ab02",  # golden yellow
  "Corylus"    = "#a6761d",  # earthy brown
  "Fagus"      = "tomato",  # charcoal grey
  "Acer"       = "#1f78b4",  # sky blue
  "Other"      = "#bdbdbd"   # light neutral grey
)
```

```{r, echo=FALSE}
# Plot
rel_top_10_libs <- ggplot(df_rel_performers, aes(x = library, y = rel_abundance, fill = genus_name)) +
  geom_col(width = 0.8) +
  scale_fill_manual(values = colours_top_libs) +
  labs(
    title = "Relative Abundance of Top 10 Genera per Library",
    x = "Library",
    y = "Relative Abundance",
    fill = "Genus"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    legend.position = "right"
  )
rel_top_10_libs

ggsave("E:/Msc/Thesis/Data/Plots/Diversity/relative_abundance_top_performersAA.jpg", plot = rel_top_10_libs, width = 16, height = 11, units = "cm" ,dpi = 300)
```

# For FINAL FIGURE
```{r, echo = FALSE}
# create underlying continuous X
df_alpha_div$index <- seq_len(nrow(df_alpha_div))

df_alpha_div <- df_alpha_div %>%
  mutate(site = fct_relevel(site, "W2", "W1", "M"))

plot_shannon_final <- ggplot(df_alpha_div, 
                       aes(x = index, y = shannon)) +
  geom_col(fill = "darkviolet", width = 0.6) +
  facet_grid(. ~ site, scales = "free_x") +

  # Replace x-axis numbers with original library labels
  scale_x_continuous(
    breaks = df_alpha_div$index,
    labels = df_alpha_div$library
  ) +

  labs(title = "Shannon-Index",
       y = "H'",
       x = " ") +
  my_theme


plot_shannon_final
ggsave("E:/Msc/Thesis/Data/Plots/Final figure/shannon.jpg", plot_shannon_final, width = 30, height = 20, units = "cm", dpi = 300)
```


